<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Movies</title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#141414;color:#fff}
header{background:#141414;padding:15px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10}
header h1{color:#e50914;margin:0;font-size:18px}
.search-container{position:relative;display:inline-block}
input[type="text"]{padding:6px;font-size:14px;width:150px;border-radius:4px;border:none}
.dropdown{position:absolute;top:100%;left:0;right:0;background:#333;border:1px solid #555;max-height:200px;overflow-y:auto;z-index:1000;display:none}
.dropdown-item{padding:8px;cursor:pointer;border-bottom:1px solid #444}
.dropdown-item:hover{background:#555}
section{margin-top:15px}
h2{margin-left:10px;font-size:16px}
.carousel-wrapper{position:relative}
.carousel{display:flex;overflow-x:auto;gap:8px;padding:15px;scroll-behavior:smooth;cursor:grab}
.carousel::-webkit-scrollbar{display:none}
.movie-card{min-width:120px;cursor:pointer;position:relative;transition:transform .2s;flex-shrink:0}
.movie-card img{width:100%;border-radius:6px;display:block}
.movie-title{position:absolute;bottom:3px;left:3px;right:3px;background:rgba(0,0,0,.7);padding:1px 3px;font-size:12px;border-radius:4px;text-align:center}
.preview-card{display:none!important}
.arrow{display:none} /* hide arrows on mobile */
</style>
<script src="config.js"></script>
<script src="utils.js"></script>
</head>
<body>
<header>
  <h1>Movies</h1>
  <div class="search-container">
    <input type="text" id="search" placeholder="Search...">
  </div>
</header>

<section>
  <h2>Trending Now</h2>
  <div class="carousel-wrapper">
      <div class="carousel" id="trending"></div>
  </div>

  <h2>Top 10</h2>
  <div class="carousel-wrapper">
      <div class="carousel" id="top10"></div>
  </div>

  <h2>My List</h2>
  <div class="carousel-wrapper">
      <div class="carousel" id="mylist"></div>
  </div>
</section>

<script defer>
let myList=[];
const trendingTitles=["Spider-Man: No Way Home","Avengers: Endgame","Joker","Black Panther","Frozen II"];
const top10Titles=["The Shawshank Redemption","The Godfather","The Dark Knight","Pulp Fiction","The Lord of the Rings: The Return of the King","Forrest Gump","Inception","Fight Club","The Matrix","Goodfellas"];

// fetch movies in parallel
async function fetchMovies(titles){
  try{
    console.log('Fetching movies for titles:', titles);
    const results=await Promise.all(titles.map(title=>
      fetch(`https://www.omdbapi.com/?apikey=${API_KEY}&t=${encodeURIComponent(title)}`).then(r=>r.json())
    ));
    console.log('Fetched results:', results);
    const filtered = results.filter(m=>m.Response==="True").map(m=>({
      title:m.Title,imdb:m.imdbID,poster:m.Poster,plot:m.Plot
    }));
    console.log('Filtered movies:', filtered);
    return filtered;
  }catch(e){console.error(e);return []}
}

// render carousel for mobile
function renderCarousel(movies,containerId, type = "movie"){
  console.log('Rendering movies for', containerId, ':', movies);
  const container=document.getElementById(containerId);
  container.innerHTML=movies.map(movie=>`
    <div class="movie-card">
      <img src="${movie.poster}" alt="${movie.title}" loading="lazy">
      <div class="movie-title">${movie.title}</div>
    </div>
  `).join("");

  container.querySelectorAll(".movie-card").forEach(card=>{
    card.onclick=()=>window.open(getVideoUrl(movies.find(m=>m.title===card.querySelector(".movie-title").innerText).imdb, type),"_blank");
  });
}

// enable swipe
function addSwipe(id){
  const slider=document.getElementById(id);
  let isDown=false,startX,scrollLeft;
  slider.addEventListener("pointerdown",e=>{isDown=true;startX=e.pageX-slider.offsetLeft;scrollLeft=slider.scrollLeft});
  slider.addEventListener("pointerleave",()=>isDown=false);
  slider.addEventListener("pointerup",()=>isDown=false);
  slider.addEventListener("pointermove",e=>{
    if(!isDown)return;
    e.preventDefault();
    slider.scrollLeft=scrollLeft-(e.pageX-startX)*2;
  });
}

async function initMovies(){
  const [trendingMovies,top10Movies]=await Promise.all([
    fetchMovies(trendingTitles),
    fetchMovies(top10Titles)
  ]);
  renderCarousel(trendingMovies,"trending", "movie");
  renderCarousel(top10Movies,"top10", "movie");
  renderCarousel(myList,"mylist", "series");
  ["trending","top10","mylist"].forEach(addSwipe);
}
initMovies();

// search
document.getElementById("search").addEventListener("input",function(e){
  const q=e.target.value.trim();
  let dropdown = document.querySelector('.dropdown');
  if (!dropdown) {
    dropdown = document.createElement('div');
    dropdown.className = 'dropdown';
    document.querySelector('.search-container').appendChild(dropdown);
  }
  if(!q || q.length < 2){
    dropdown.style.display = 'none';
    return;
  }
  fetch(`https://www.omdbapi.com/?apikey=${API_KEY}&s=${encodeURIComponent(q)}`)
    .then(r=>r.json())
    .then(d=>{
      const results = d.Search || [];
      if(results.length === 0){
        dropdown.style.display = 'none';
        return;
      }
      dropdown.innerHTML = results.slice(0,5).map(r=>`<div class="dropdown-item" data-imdb="${r.imdbID}" data-type="${r.Type}">${r.Title} (${r.Year}) - ${r.Type}</div>`).join('');
      dropdown.style.display = 'block';
    })
    .catch(console.error);
});

document.getElementById("search").addEventListener("keypress",function(e){
  if(e.key==="Enter"){
    const q=e.target.value.trim();
    if(!q)return;
    fetch(`https://www.omdbapi.com/?apikey=${API_KEY}&s=${encodeURIComponent(q)}`)
      .then(r=>r.json())
      .then(d=>{
        if(d.Search && d.Search.length > 0){
          // Determine if first result is movie or series and open accordingly
          const first = d.Search[0];
          const type = first.Type === "series" ? "series" : "movie";
          window.open(getVideoUrl(first.imdbID, type), "_blank");
        } else {
          alert("Movie not found!");
        }
      })
      .catch(console.error);
  }
});

// handle dropdown clicks
document.addEventListener('click', function(e){
  const dropdown = document.querySelector('.dropdown');
  if (e.target.classList.contains('dropdown-item')) {
    const imdb = e.target.dataset.imdb;
    const type = e.target.dataset.type;
    window.open(getVideoUrl(imdb, type === 'series' ? 'series' : 'movie'), '_blank');
    if (dropdown) dropdown.style.display = 'none';
    document.getElementById('search').value = '';
  } else if (dropdown && !document.querySelector('.search-container').contains(e.target)) {
    dropdown.style.display = 'none';
  }
});
</script>
</body>
</html>
