<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Movies</title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#141414;color:#fff}
header{background:#141414;padding:15px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:10}
header h1{color:#e50914;margin:0;font-size:18px}
.search-container{position:relative;display:inline-block}
input[type="text"]{padding:6px;font-size:14px;width:150px;border-radius:4px;border:none}
.dropdown{position:absolute;top:100%;left:0;right:0;background:#333;border:1px solid #555;max-height:200px;overflow-y:auto;z-index:1000;display:none}
.dropdown-item{padding:8px;cursor:pointer;border-bottom:1px solid #444}
.dropdown-item:hover{background:#555}
section{margin-top:15px}
h2{margin-left:10px;font-size:16px}
.carousel-wrapper{position:relative}
.carousel{display:flex;overflow-x:auto;gap:8px;padding:15px;scroll-behavior:smooth;cursor:grab}
.carousel::-webkit-scrollbar{display:none}
.movie-card{min-width:120px;cursor:pointer;position:relative;transition:transform .2s;flex-shrink:0}
.movie-card img{width:100%;border-radius:6px;display:block}
.movie-title{position:absolute;bottom:3px;left:3px;right:3px;background:rgba(0,0,0,.7);padding:1px 3px;font-size:12px;border-radius:4px;text-align:center}
.preview-card{display:none!important}
.arrow{display:none} /* hide arrows on mobile */

/* Video Provider Modal Styles */
.video-modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.9);
}

.video-modal-content {
  background-color: #1a1a1a;
  margin: 10% auto;
  padding: 20px;
  border: 1px solid #333;
  border-radius: 8px;
  width: 80%;
  max-width: 600px;
  color: white;
}

.video-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.video-modal-header h3 {
  margin: 0;
  color: #e50914;
}

.close-modal {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.close-modal:hover {
  color: white;
}

.provider-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.provider-btn {
  background: #333;
  border: 1px solid #555;
  color: white;
  padding: 15px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
}

.provider-btn:hover {
  background: #e50914;
  border-color: #e50914;
}

.provider-btn.selected {
  background: #e50914;
  border-color: #e50914;
}

.video-container {
  width: 100%;
  height: 400px;
  border: 1px solid #333;
  border-radius: 6px;
  overflow: hidden;
  display: none;
}

.video-iframe {
  width: 100%;
  height: 100%;
  border: none;
}
</style>
<script>
const WORKER_URL = 'https://noisy-frog-a9ab.22afed28-f0b2-46d0-8804-c90e25c90bd4.workers.dev';
</script>
</head>
<body>
<header>
  <h1>Movies</h1>
  <div class="search-container">
    <input type="text" id="search" placeholder="Search...">
  </div>
</header>

<section>
  <h2>Trending Now</h2>
  <div class="carousel-wrapper">
      <div class="carousel" id="trending"></div>
  </div>

  <h2>Top 10</h2>
  <div class="carousel-wrapper">
      <div class="carousel" id="top10"></div>
  </div>

  <h2>My List</h2>
  <div class="carousel-wrapper">
      <div class="carousel" id="mylist"></div>
  </div>
</section>

<!-- Video Provider Modal -->
<div id="videoModal" class="video-modal">
  <div class="video-modal-content">
    <div class="video-modal-header">
      <h3 id="modalTitle">Select Video Provider</h3>
      <span class="close-modal" id="closeModal">&times;</span>
    </div>
    <div id="providerGrid" class="provider-grid">
      <!-- Provider buttons will be added here by JavaScript -->
    </div>
    <div id="videoContainer" class="video-container">
      <iframe id="videoIframe" class="video-iframe" src="" allowfullscreen></iframe>
    </div>
  </div>
</div>

<script defer>
let myList=[];
const trendingTitles=[
  "The Toxic Avenger",
  "Get Out",
  "Avengers: Endgame",
  "Orphan",
  "The Smashing Machine",
  "Thor: Ragnarok",
  "Relay",
  "Joker",
  "Avengers: Infinity War",
  "The Threesome",
  "It",
  "Spider-Man 3"
];
const top10Titles=[
  "Wednesday",
  "Dexter: Resurrection",
  "The Conjuring: Last Rites",
  "The Thursday Murder Club",
  "Highest 2 Lowest",
  "Alien: Earth",
  "The Paper",
  "Weapons",
  "The Terminal List: Dark Wolf",
  "Wuthering Heights"
];

// fetch movies in parallel
async function fetchMovies(titles){
  try{
    console.log('Fetching movies for titles:', titles);
    const results=await Promise.all(titles.map(title=>
      fetch(`${WORKER_URL}/api/movie?t=${encodeURIComponent(title)}`).then(r=>r.json())
    ));
    console.log('Fetched results:', results);
    const filtered = results.filter(m=>m.Response==="True").map(m=>({
      title:m.Title,imdb:m.imdbID,poster:m.Poster,plot:m.Plot
    }));
    console.log('Filtered movies:', filtered);
    return filtered;
  }catch(e){console.error(e);return []}
}

// render carousel for mobile
function renderCarousel(movies,containerId, type = "movie"){
  console.log('Rendering movies for', containerId, ':', movies);
  const container=document.getElementById(containerId);
  container.innerHTML=movies.map(movie=>`
    <div class="movie-card" data-imdb="${movie.imdb}">
      <img src="${movie.poster}" alt="${movie.title}" loading="lazy">
      <div class="movie-title">${movie.title}</div>
    </div>
  `).join("");

  container.querySelectorAll(".movie-card").forEach(card=>{
    card.onclick=async ()=>{
      try {
        const imdb = card.dataset.imdb;
        const title = card.querySelector('.movie-title').textContent;

        // Show provider selection modal instead of opening directly
        showVideoModal(title, imdb, type);
      } catch (err) {
        console.error(err);
        alert("Failed to load video options");
      }
    };
  });
}

// enable swipe
function addSwipe(id){
  const slider=document.getElementById(id);
  let isDown=false,startX,scrollLeft;
  slider.addEventListener("pointerdown",e=>{isDown=true;startX=e.pageX-slider.offsetLeft;scrollLeft=slider.scrollLeft});
  slider.addEventListener("pointerleave",()=>isDown=false);
  slider.addEventListener("pointerup",()=>isDown=false);
  slider.addEventListener("pointermove",e=>{
    if(!isDown)return;
    e.preventDefault();
    slider.scrollLeft=scrollLeft-(e.pageX-startX)*2;
  });
}

async function initMovies(){
  const [trendingMovies,top10Movies]=await Promise.all([
    fetchMovies(trendingTitles),
    fetchMovies(top10Titles)
  ]);
  renderCarousel(trendingMovies,"trending", "movie");
  renderCarousel(top10Movies,"top10", "movie");
  renderCarousel(myList,"mylist", "series");
  ["trending","top10","mylist"].forEach(addSwipe);
}
initMovies();

// search
document.getElementById("search").addEventListener("input",function(e){
  const q=e.target.value.trim();
  let dropdown = document.querySelector('.dropdown');
  if (!dropdown) {
    dropdown = document.createElement('div');
    dropdown.className = 'dropdown';
    document.querySelector('.search-container').appendChild(dropdown);
  }
  if(!q || q.length < 2){
    dropdown.style.display = 'none';
    return;
  }
  fetch(`${WORKER_URL}/api/search?s=${encodeURIComponent(q)}`)
    .then(r=>r.json())
    .then(d=>{
      const results = d.Search || [];
      if(results.length === 0){
        dropdown.style.display = 'none';
        return;
      }
      dropdown.innerHTML = results.slice(0,5).map(r=>`<div class="dropdown-item" data-imdb="${r.imdbID}" data-type="${r.Type}">${r.Title} (${r.Year}) - ${r.Type}</div>`).join('');
      dropdown.style.display = 'block';
    })
    .catch(console.error);
});

document.getElementById("search").addEventListener("keypress",async function(e){
  if(e.key==="Enter"){
    const q=e.target.value.trim();
    if(!q)return;
    try {
      const res = await fetch(`${WORKER_URL}/api/search?s=${encodeURIComponent(q)}`);
      const d = await res.json();
      if(d.Search && d.Search.length > 0){
        // Determine if first result is movie or series and show provider selection
        const first = d.Search[0];
        const type = first.Type === "series" ? "series" : "movie";
        const title = first.Title;

        // Show provider selection instead of opening directly
        showVideoModal(title, first.imdbID, type);

        // Clear search input
        document.getElementById('search').value = '';
      } else {
        alert("Movie not found!");
      }
    } catch (err) {
      console.error(err);
      alert("Search failed");
    }
  }
});

// Video provider configuration
const videoProviders = [
  { name: 'VidSrc.cc', domain: 'vidsrc.cc' },
  { name: 'VidRock.net', domain: 'vidrock.net' },
  { name: 'VidSrc.me', domain: 'vidsrc.me' },
  { name: 'VidFast.pro', domain: 'vidfast.pro' }
];

// Generate embed URL for a provider
function generateEmbedUrl(provider, imdbId, type) {
  const baseUrls = {
    'vidsrc.cc': type === 'series'
      ? `https://vidsrc.cc/v2/embed/tv/${imdbId}/1?ads=0&disable_ads=1`
      : `https://vidsrc.cc/v2/embed/movie/${imdbId}?ads=0&disable_ads=1`,
    'vidrock.net': type === 'series'
      ? `https://vidrock.net/tv/${imdbId}/1/1?ads=0&disable_ads=1`
      : `https://vidrock.net/movie/${imdbId}?ads=0&disable_ads=1`,
    'vidsrc.me': `https://vidsrc.me/embed/${type}/${imdbId}?ads=0&disable_ads=1`,
    'vidfast.pro': type === 'series'
      ? `https://vidfast.pro/tv/${imdbId}/1/1?autoPlay=true&ads=0&disable_ads=1`
      : `https://vidfast.pro/movie/${imdbId}?autoPlay=true&ads=0&disable_ads=1`
  };

  return baseUrls[provider] || '';
}

// Show video provider modal
function showVideoModal(title, imdbId, type) {
  const modal = document.getElementById('videoModal');
  const modalTitle = document.getElementById('modalTitle');
  const providerGrid = document.getElementById('providerGrid');
  const videoContainer = document.getElementById('videoContainer');
  const videoIframe = document.getElementById('videoIframe');

  // Set modal title
  modalTitle.textContent = `Select ${type === 'series' ? 'Episode' : 'Video'} Provider for ${title}`;
  modalTitle.dataset.imdb = imdbId;
  modalTitle.dataset.type = type;

  // Clear previous content
  providerGrid.innerHTML = '';
  videoContainer.style.display = 'none';
  videoIframe.src = '';

  // Add provider buttons
  videoProviders.forEach(provider => {
    const button = document.createElement('button');
    button.className = 'provider-btn';
    button.textContent = provider.name;
    button.dataset.provider = provider.domain;
    button.onclick = () => selectProvider(provider.domain, imdbId, type, title);
    providerGrid.appendChild(button);
  });

  // Show modal
  modal.style.display = 'block';
}

// Select video provider and load video
function selectProvider(provider, imdbId, type, title) {
  const embedUrl = generateEmbedUrl(provider, imdbId, type);

  if (embedUrl) {
    // Close the modal
    closeVideoModal();

    // Open video in new tab
    window.open(embedUrl, '_blank');

    console.log(`Opened ${title} on ${provider}: ${embedUrl}`);
  } else {
    alert(`Unable to generate embed URL for ${provider}`);
  }
}

// Close modal
function closeVideoModal() {
  const modal = document.getElementById('videoModal');
  const videoIframe = document.getElementById('videoIframe');

  modal.style.display = 'none';
  videoIframe.src = '';
  document.getElementById('providerGrid').style.display = 'grid';
  document.getElementById('modalTitle').textContent = 'Select Video Provider';
}

// Modal event listeners
document.getElementById('closeModal').onclick = closeVideoModal;

// Close modal when clicking outside
document.getElementById('videoModal').onclick = function(e) {
  if (e.target === this) {
    closeVideoModal();
  }
};

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeVideoModal();
  }
});

// handle dropdown clicks
document.addEventListener('click', async function(e){
  const dropdown = document.querySelector('.dropdown');
  if (e.target.classList.contains('dropdown-item')) {
    const imdb = e.target.dataset.imdb;
    const type = e.target.dataset.type;
    const title = e.target.textContent.split(' (')[0]; // Extract title from dropdown text

    // Show provider selection instead of opening directly
    showVideoModal(title, imdb, type);

    if (dropdown) dropdown.style.display = 'none';
    document.getElementById('search').value = '';
  } else if (dropdown && !document.querySelector('.search-container').contains(e.target)) {
    dropdown.style.display = 'none';
  }
});
</script>
</body>
</html>
